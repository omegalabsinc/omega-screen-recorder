name: Build and Release

# This workflow builds self-contained macOS binaries with bundled FFmpeg libraries
# Users do NOT need to install FFmpeg - all required dylibs are included

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos-arm:
    name: Build macOS ARM64
    runs-on: macos-latest  # Latest macOS ARM64 runner

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: aarch64-apple-darwin

    - name: Install FFmpeg and build dependencies
      run: |
        # Install FFmpeg 7.x
        brew uninstall --ignore-dependencies ffmpeg 2>/dev/null || true
        brew tap homebrew/core
        # Install FFmpeg 7 specifically
        brew install ffmpeg@7 2>/dev/null || brew install ffmpeg
        brew install pkg-config nasm

        # Link ffmpeg@7 if it was installed
        if [ -d "/opt/homebrew/opt/ffmpeg@7" ]; then
          brew link --overwrite ffmpeg@7
        fi

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache target directory
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Build and package binary
      run: |
        # Find where FFmpeg is actually installed
        if [ -d "/opt/homebrew/opt/ffmpeg@7" ]; then
          FFMPEG_PREFIX="/opt/homebrew/opt/ffmpeg@7"
        elif [ -d "/opt/homebrew/opt/ffmpeg" ]; then
          FFMPEG_PREFIX="/opt/homebrew/opt/ffmpeg"
        else
          FFMPEG_PREFIX="/opt/homebrew"
        fi

        echo "=== FFmpeg Setup ==="
        echo "FFmpeg prefix: $FFMPEG_PREFIX"

        # Verify FFmpeg headers exist
        if [ -d "$FFMPEG_PREFIX/include/libavcodec" ]; then
          echo "âœ… FFmpeg headers found at: $FFMPEG_PREFIX/include"
          ls -la "$FFMPEG_PREFIX/include" | grep libav
        else
          echo "âš ï¸ FFmpeg headers not found at expected location"
        fi
        echo ""

        # Set up environment variables
        export PKG_CONFIG_PATH="$FFMPEG_PREFIX/lib/pkgconfig:/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH"
        export FFMPEG_PKG_CONFIG_PATH="$FFMPEG_PREFIX/lib/pkgconfig"
        export FFMPEG_DIR="$FFMPEG_PREFIX"
        export FFMPEG_PREFIX="$FFMPEG_PREFIX"
        export FFMPEG_INCLUDE_DIR="$FFMPEG_PREFIX/include"
        export FFMPEG_LIB_DIR="$FFMPEG_PREFIX/lib"

        # Additional environment variables
        export C_INCLUDE_PATH="$FFMPEG_PREFIX/include:$C_INCLUDE_PATH"
        export CPLUS_INCLUDE_PATH="$FFMPEG_PREFIX/include:$CPLUS_INCLUDE_PATH"
        export LIBRARY_PATH="$FFMPEG_PREFIX/lib:$LIBRARY_PATH"
        export DYLD_LIBRARY_PATH="$FFMPEG_PREFIX/lib:$DYLD_LIBRARY_PATH"

        # For bindgen
        export BINDGEN_EXTRA_CLANG_ARGS="-I$FFMPEG_PREFIX/include -I/usr/include"

        echo "=== Environment Variables ==="
        echo "FFMPEG_DIR: $FFMPEG_DIR"
        echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
        echo "BINDGEN_EXTRA_CLANG_ARGS: $BINDGEN_EXTRA_CLANG_ARGS"
        echo ""

        echo "=== FFmpeg version ==="
        pkg-config --modversion libavcodec || echo "libavcodec not found via pkg-config"
        echo ""

        # Build the release binary
        cargo build --release --target aarch64-apple-darwin

        # Bundle FFmpeg libraries with the binary
        echo "=== Bundling FFmpeg libraries ==="
        chmod +x ./scripts/bundle-ffmpeg-libs.sh
        ./scripts/bundle-ffmpeg-libs.sh ./target/aarch64-apple-darwin/release/omgrec

        # Create distribution package
        mkdir -p target/package-macos-arm64
        cp ./target/aarch64-apple-darwin/release/omgrec target/package-macos-arm64/
        cp -r ./target/aarch64-apple-darwin/release/lib target/package-macos-arm64/

        echo "=== Package contents ==="
        ls -lh target/package-macos-arm64/
        ls -lh target/package-macos-arm64/lib/

    - name: Create zip archive
      run: |
        cd target/package-macos-arm64
        zip -r ../omgrec-macos-arm64.zip omgrec lib/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: omgrec-macos-arm64
        path: target/omgrec-macos-arm64.zip

  build-macos-intel:
    name: Build macOS x86_64
    runs-on: macos-15-intel  # macOS 15 Intel runner

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: x86_64-apple-darwin

    - name: Install FFmpeg and build dependencies
      run: |
        # Install FFmpeg 7.x
        brew uninstall --ignore-dependencies ffmpeg 2>/dev/null || true
        brew tap homebrew/core
        # Install FFmpeg 7 specifically
        brew install ffmpeg@7 2>/dev/null || brew install ffmpeg
        brew install pkg-config nasm

        # Link ffmpeg@7 if it was installed (Intel uses /usr/local)
        if [ -d "/usr/local/opt/ffmpeg@7" ]; then
          brew link --overwrite ffmpeg@7
        fi

    - name: Build and package binary
      run: |
        # Find where FFmpeg is actually installed (Intel paths on macos-13)
        if [ -d "/usr/local/opt/ffmpeg@7" ]; then
          FFMPEG_PREFIX="/usr/local/opt/ffmpeg@7"
        elif [ -d "/usr/local/opt/ffmpeg" ]; then
          FFMPEG_PREFIX="/usr/local/opt/ffmpeg"
        else
          FFMPEG_PREFIX="/usr/local"
        fi

        echo "=== FFmpeg Setup ==="
        echo "FFmpeg prefix: $FFMPEG_PREFIX"

        # Verify FFmpeg headers exist
        if [ -d "$FFMPEG_PREFIX/include/libavcodec" ]; then
          echo "âœ… FFmpeg headers found at: $FFMPEG_PREFIX/include"
          ls -la "$FFMPEG_PREFIX/include" | grep libav
        else
          echo "âš ï¸ FFmpeg headers not found at expected location"
        fi
        echo ""

        # Set up environment variables
        export PKG_CONFIG_PATH="$FFMPEG_PREFIX/lib/pkgconfig:/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH"
        export FFMPEG_PKG_CONFIG_PATH="$FFMPEG_PREFIX/lib/pkgconfig"
        export FFMPEG_DIR="$FFMPEG_PREFIX"
        export FFMPEG_PREFIX="$FFMPEG_PREFIX"
        export FFMPEG_INCLUDE_DIR="$FFMPEG_PREFIX/include"
        export FFMPEG_LIB_DIR="$FFMPEG_PREFIX/lib"

        # Additional environment variables
        export C_INCLUDE_PATH="$FFMPEG_PREFIX/include:$C_INCLUDE_PATH"
        export CPLUS_INCLUDE_PATH="$FFMPEG_PREFIX/include:$CPLUS_INCLUDE_PATH"
        export LIBRARY_PATH="$FFMPEG_PREFIX/lib:$LIBRARY_PATH"
        export DYLD_LIBRARY_PATH="$FFMPEG_PREFIX/lib:$DYLD_LIBRARY_PATH"

        # For bindgen
        export BINDGEN_EXTRA_CLANG_ARGS="-I$FFMPEG_PREFIX/include -I/usr/include"

        echo "=== Environment Variables ==="
        echo "FFMPEG_DIR: $FFMPEG_DIR"
        echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
        echo "BINDGEN_EXTRA_CLANG_ARGS: $BINDGEN_EXTRA_CLANG_ARGS"
        echo ""

        echo "=== FFmpeg version ==="
        pkg-config --modversion libavcodec || echo "libavcodec not found via pkg-config"
        echo ""

        # Build the release binary
        cargo build --release --target x86_64-apple-darwin

        # Bundle FFmpeg libraries with the binary
        echo "=== Bundling FFmpeg libraries ==="
        chmod +x ./scripts/bundle-ffmpeg-libs.sh
        ./scripts/bundle-ffmpeg-libs.sh ./target/x86_64-apple-darwin/release/omgrec

        # Create distribution package
        mkdir -p target/package-macos-x86_64
        cp ./target/x86_64-apple-darwin/release/omgrec target/package-macos-x86_64/
        cp -r ./target/x86_64-apple-darwin/release/lib target/package-macos-x86_64/

        echo "=== Package contents ==="
        ls -lh target/package-macos-x86_64/
        ls -lh target/package-macos-x86_64/lib/

    - name: Create zip archive
      run: |
        cd target/package-macos-x86_64
        zip -r ../omgrec-macos-x86_64.zip omgrec lib/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: omgrec-macos-x86_64
        path: target/omgrec-macos-x86_64.zip

  release:
    name: Create Release
    needs: [build-macos-arm, build-macos-intel]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: List downloaded artifacts
      run: |
        echo "=== Downloaded artifacts ==="
        ls -la
        echo "=== Contents ==="
        find . -type f

    - name: Determine version and create tag
      id: vars
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          # If triggered by a tag, use that tag
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_manual_tag=true" >> $GITHUB_OUTPUT
        else
          # Read current version from VERSION file
          if [ -f VERSION ]; then
            BASE_VERSION=$(cat VERSION)
          else
            BASE_VERSION="0.2.0"
          fi

          # Get the build number from the run number
          BUILD_NUMBER="${{ github.run_number }}"

          # Create version with build number: v0.2.0-build.123
          VERSION="v${BASE_VERSION}-build.${BUILD_NUMBER}"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_manual_tag=false" >> $GITHUB_OUTPUT

          # Create and push the tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "Auto-generated release $VERSION"
          git push origin "$VERSION"
        fi

        echo "ðŸ“¦ Release version: $VERSION"

    - name: Create or Update Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.vars.outputs.version }}
        name: ${{ steps.vars.outputs.version }}
        files: |
          omgrec-macos-arm64/omgrec-macos-arm64.zip
          omgrec-macos-x86_64/omgrec-macos-x86_64.zip
        draft: false
        prerelease: ${{ steps.vars.outputs.is_manual_tag == 'false' }}
        generate_release_notes: true
        fail_on_unmatched_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}