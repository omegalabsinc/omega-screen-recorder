name: Build and Release

# This build does NOT bundle FFmpeg - users must have FFmpeg installed
# Users can either install FFmpeg globally or use --ffmpeg-path argument

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos-arm:
    name: Build macOS ARM64
    runs-on: macos-14  # macOS 14 runs on Apple Silicon (M1/M2)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: aarch64-apple-darwin

    - name: Install FFmpeg and build dependencies
      run: |
        # Install FFmpeg 6.x instead of 7.x to avoid compatibility issues
        brew uninstall --ignore-dependencies ffmpeg 2>/dev/null || true
        brew tap homebrew/core
        # Try to install FFmpeg 6.1 specifically
        brew install ffmpeg@6 2>/dev/null || brew install ffmpeg
        brew install pkg-config nasm
        
        # Link ffmpeg@6 if it was installed
        if [ -d "/opt/homebrew/opt/ffmpeg@6" ]; then
          brew link --overwrite ffmpeg@6
        fi

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache target directory
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Build and package binary
      run: |
        # Find where FFmpeg is actually installed
        if [ -d "/opt/homebrew/opt/ffmpeg@6" ]; then
          FFMPEG_PREFIX="/opt/homebrew/opt/ffmpeg@6"
        elif [ -d "/opt/homebrew/opt/ffmpeg" ]; then
          FFMPEG_PREFIX="/opt/homebrew/opt/ffmpeg"
        else
          FFMPEG_PREFIX="/opt/homebrew"
        fi

        echo "=== FFmpeg Setup ==="
        echo "FFmpeg prefix: $FFMPEG_PREFIX"

        # Verify FFmpeg headers exist
        if [ -d "$FFMPEG_PREFIX/include/libavcodec" ]; then
          echo "✅ FFmpeg headers found at: $FFMPEG_PREFIX/include"
          ls -la "$FFMPEG_PREFIX/include" | grep libav
        else
          echo "⚠️ FFmpeg headers not found at expected location"
        fi
        echo ""

        # Set up environment variables
        export PKG_CONFIG_PATH="$FFMPEG_PREFIX/lib/pkgconfig:/opt/homebrew/lib/pkgconfig:$PKG_CONFIG_PATH"
        export FFMPEG_PKG_CONFIG_PATH="$FFMPEG_PREFIX/lib/pkgconfig"
        export FFMPEG_DIR="$FFMPEG_PREFIX"
        export FFMPEG_PREFIX="$FFMPEG_PREFIX"
        export FFMPEG_INCLUDE_DIR="$FFMPEG_PREFIX/include"
        export FFMPEG_LIB_DIR="$FFMPEG_PREFIX/lib"

        # Additional environment variables
        export C_INCLUDE_PATH="$FFMPEG_PREFIX/include:$C_INCLUDE_PATH"
        export CPLUS_INCLUDE_PATH="$FFMPEG_PREFIX/include:$CPLUS_INCLUDE_PATH"
        export LIBRARY_PATH="$FFMPEG_PREFIX/lib:$LIBRARY_PATH"
        export DYLD_LIBRARY_PATH="$FFMPEG_PREFIX/lib:$DYLD_LIBRARY_PATH"

        # For bindgen
        export BINDGEN_EXTRA_CLANG_ARGS="-I$FFMPEG_PREFIX/include -I/usr/include"

        echo "=== Environment Variables ==="
        echo "FFMPEG_DIR: $FFMPEG_DIR"
        echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
        echo "BINDGEN_EXTRA_CLANG_ARGS: $BINDGEN_EXTRA_CLANG_ARGS"
        echo ""

        echo "=== FFmpeg version ==="
        pkg-config --modversion libavcodec || echo "libavcodec not found via pkg-config"
        echo ""

        # Run the simplified packaging script (no FFmpeg bundling)
        chmod +x ./scripts/package-simple.sh
        ./scripts/package-simple.sh

    - name: Create zip archive
      run: |
        cd target/package-macos-arm64
        zip -r ../omgrec-macos-arm64.zip *

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: omgrec-macos-arm64
        path: omgrec-macos-arm64.zip

  build-macos-intel:
    name: Build macOS x86_64
    runs-on: macos-13  # macOS 13 runs on Intel

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: x86_64-apple-darwin

    - name: Install FFmpeg and build dependencies
      run: |
        # Install FFmpeg 6.x instead of 7.x to avoid compatibility issues
        brew uninstall --ignore-dependencies ffmpeg 2>/dev/null || true
        brew tap homebrew/core
        # Try to install FFmpeg 6.1 specifically
        brew install ffmpeg@6 2>/dev/null || brew install ffmpeg
        brew install pkg-config nasm
        
        # Link ffmpeg@6 if it was installed
        if [ -d "/usr/local/opt/ffmpeg@6" ]; then
          brew link --overwrite ffmpeg@6
        fi

    - name: Build and package binary
      run: |
        # Find where FFmpeg is actually installed
        if [ -d "/usr/local/opt/ffmpeg@6" ]; then
          FFMPEG_PREFIX="/usr/local/opt/ffmpeg@6"
        elif [ -d "/usr/local/opt/ffmpeg" ]; then
          FFMPEG_PREFIX="/usr/local/opt/ffmpeg"
        else
          FFMPEG_PREFIX="/usr/local"
        fi

        echo "=== FFmpeg Setup ==="
        echo "FFmpeg prefix: $FFMPEG_PREFIX"

        # Verify FFmpeg headers exist
        if [ -d "$FFMPEG_PREFIX/include/libavcodec" ]; then
          echo "✅ FFmpeg headers found at: $FFMPEG_PREFIX/include"
          ls -la "$FFMPEG_PREFIX/include" | grep libav
        else
          echo "⚠️ FFmpeg headers not found at expected location"
        fi
        echo ""

        # Set up environment variables
        export PKG_CONFIG_PATH="$FFMPEG_PREFIX/lib/pkgconfig:/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH"
        export FFMPEG_PKG_CONFIG_PATH="$FFMPEG_PREFIX/lib/pkgconfig"
        export FFMPEG_DIR="$FFMPEG_PREFIX"
        export FFMPEG_PREFIX="$FFMPEG_PREFIX"
        export FFMPEG_INCLUDE_DIR="$FFMPEG_PREFIX/include"
        export FFMPEG_LIB_DIR="$FFMPEG_PREFIX/lib"

        # Additional environment variables
        export C_INCLUDE_PATH="$FFMPEG_PREFIX/include:$C_INCLUDE_PATH"
        export CPLUS_INCLUDE_PATH="$FFMPEG_PREFIX/include:$CPLUS_INCLUDE_PATH"
        export LIBRARY_PATH="$FFMPEG_PREFIX/lib:$LIBRARY_PATH"
        export DYLD_LIBRARY_PATH="$FFMPEG_PREFIX/lib:$DYLD_LIBRARY_PATH"

        # For bindgen
        export BINDGEN_EXTRA_CLANG_ARGS="-I$FFMPEG_PREFIX/include -I/usr/include"

        echo "=== Environment Variables ==="
        echo "FFMPEG_DIR: $FFMPEG_DIR"
        echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
        echo "BINDGEN_EXTRA_CLANG_ARGS: $BINDGEN_EXTRA_CLANG_ARGS"
        echo ""

        echo "=== FFmpeg version ==="
        pkg-config --modversion libavcodec || echo "libavcodec not found via pkg-config"
        echo ""

        # Run the simplified packaging script (no FFmpeg bundling)
        chmod +x ./scripts/package-simple.sh
        ./scripts/package-simple.sh

    - name: Create zip archive
      run: |
        cd target/package-macos-x86_64
        zip -r ../omgrec-macos-x86_64.zip *

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: omgrec-macos-x86_64
        path: omgrec-macos-x86_64.zip

  build-linux:
    name: Build Linux x86_64
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: x86_64-unknown-linux-gnu

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libavfilter-dev \
          libavdevice-dev \
          libswscale-dev \
          libswresample-dev \
          pkg-config \
          clang \
          libx11-dev \
          libxrandr-dev \
          libasound2-dev

    - name: Build and package binary
      env:
        PKG_CONFIG_PATH: /usr/lib/x86_64-linux-gnu/pkgconfig
        # For Linux, FFmpeg is typically in /usr
        FFMPEG_DIR: /usr
        FFMPEG_INCLUDE_DIR: /usr/include
        FFMPEG_LIB_DIR: /usr/lib/x86_64-linux-gnu
      run: |
        # Debug info
        echo "=== FFmpeg headers check ==="
        ls -la /usr/include/libavcodec/ | head -10 || echo "libavcodec headers not found"
        echo ""
        echo "=== pkg-config info ==="
        pkg-config --modversion libavcodec || echo "libavcodec not found via pkg-config"
        echo ""

        # Run the simplified packaging script (no FFmpeg bundling)
        chmod +x ./scripts/package-simple.sh
        ./scripts/package-simple.sh

    - name: Create zip archive
      run: |
        cd target/package-linux-x86_64
        zip -r ../omgrec-linux-x86_64.zip *

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: omgrec-linux-x86_64
        path: omgrec-linux-x86_64.zip

  release:
    name: Create Release
    needs: [build-macos-arm, build-macos-intel, build-linux]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Get commit SHA for release tag
      id: vars
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "is_tag=true" >> $GITHUB_OUTPUT
        else
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "tag=build-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "is_tag=false" >> $GITHUB_OUTPUT
        fi

    - name: Create or Update Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.vars.outputs.tag }}
        name: ${{ steps.vars.outputs.is_tag == 'true' && steps.vars.outputs.tag || format('Build {0}', steps.vars.outputs.tag) }}
        files: |
          omgrec-macos-arm64/omgrec-macos-arm64.zip
          omgrec-macos-x86_64/omgrec-macos-x86_64.zip
          omgrec-linux-x86_64/omgrec-linux-x86_64.zip
        draft: false
        prerelease: ${{ steps.vars.outputs.is_tag == 'false' }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}