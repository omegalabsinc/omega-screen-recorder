name: Build and Release

# This workflow builds macOS binaries using subprocess-based FFmpeg encoding
# FFmpeg is NOT bundled - users must have FFmpeg installed or provide --ffmpeg-path

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos-arm:
    name: Build macOS ARM64
    runs-on: macos-latest  # Latest macOS ARM64 runner

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: aarch64-apple-darwin

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache target directory
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Build and package binary
      run: |
        # macOS uses subprocess-based FFmpeg encoder (no FFmpeg needed at build time)
        echo "=== Building macOS ARM64 binary ==="
        cargo build --release --target aarch64-apple-darwin

        # Create simple package (binary only - no library bundling)
        mkdir -p target/package-macos-arm64
        cp ./target/aarch64-apple-darwin/release/omgrec target/package-macos-arm64/

        # Create README using script
        chmod +x ./scripts/create-package-readme.sh
        ./scripts/create-package-readme.sh arm64 target/package-macos-arm64

        echo "=== Package contents ==="
        ls -lh target/package-macos-arm64/

    - name: Create zip archive
      run: |
        cd target/package-macos-arm64
        zip -r ../omgrec-macos-arm64.zip omgrec README.txt

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: omgrec-macos-arm64
        path: target/omgrec-macos-arm64.zip

  build-macos-intel:
    name: Build macOS x86_64
    runs-on: macos-15-intel  # macOS 15 Intel runner

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: x86_64-apple-darwin

    - name: Build and package binary
      run: |
        # macOS uses subprocess-based FFmpeg encoder (no FFmpeg needed at build time)
        echo "=== Building macOS x86_64 binary ==="
        cargo build --release --target x86_64-apple-darwin

        # Create simple package (binary only - no library bundling)
        mkdir -p target/package-macos-x86_64
        cp ./target/x86_64-apple-darwin/release/omgrec target/package-macos-x86_64/

        # Create README using script
        chmod +x ./scripts/create-package-readme.sh
        ./scripts/create-package-readme.sh x86_64 target/package-macos-x86_64

        echo "=== Package contents ==="
        ls -lh target/package-macos-x86_64/

    - name: Create zip archive
      run: |
        cd target/package-macos-x86_64
        zip -r ../omgrec-macos-x86_64.zip omgrec README.txt

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: omgrec-macos-x86_64
        path: target/omgrec-macos-x86_64.zip

  release:
    name: Create Release
    needs: [build-macos-arm, build-macos-intel]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: List downloaded artifacts
      run: |
        echo "=== Downloaded artifacts ==="
        ls -la
        echo "=== Contents ==="
        find . -type f

    - name: Determine version and create tag
      id: vars
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          # If triggered by a tag, use that tag
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_manual_tag=true" >> $GITHUB_OUTPUT
        else
          # Extract version from Cargo.toml
          BASE_VERSION=$(grep -m1 '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')

          if [ -z "$BASE_VERSION" ]; then
            echo "Error: Could not extract version from Cargo.toml"
            exit 1
          fi

          # Get the build number from the run number
          BUILD_NUMBER="${{ github.run_number }}"

          # Create version with build number: v1.4.3-build.123
          VERSION="v${BASE_VERSION}-build.${BUILD_NUMBER}"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_manual_tag=false" >> $GITHUB_OUTPUT

          # Create and push the tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "Auto-generated release $VERSION"
          git push origin "$VERSION"
        fi

        echo "ðŸ“¦ Release version: $VERSION"

    - name: Create or Update Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.vars.outputs.version }}
        name: ${{ steps.vars.outputs.version }}
        files: |
          omgrec-macos-arm64/omgrec-macos-arm64.zip
          omgrec-macos-x86_64/omgrec-macos-x86_64.zip
        draft: false
        prerelease: ${{ steps.vars.outputs.is_manual_tag == 'false' }}
        generate_release_notes: true
        fail_on_unmatched_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}