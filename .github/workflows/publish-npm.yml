name: Publish npm Package

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag / release to publish"
        required: false

jobs:
  publish:
    name: Publish @omega/screenrec-cli
    runs-on: ubuntu-latest
    env:
      TAG_NAME: ${{ github.event.release.tag_name || inputs.tag || github.ref_name }}
      SCREENREC_BINARY_BASE_URL: https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name || inputs.tag || github.ref_name }}
    steps:
      - name: Check tag input when manually triggered
        if: github.event_name == 'workflow_dispatch' && env.TAG_NAME == ''
        run: |
          echo "You must provide the release tag via the 'tag' input when manually dispatching."
          exit 1

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure tag exists
        run: |
          if ! git rev-parse "${TAG_NAME}" >/dev/null 2>&1; then
            echo "Tag ${TAG_NAME} not found in repository."
            exit 1
          fi
          git checkout "${TAG_NAME}"

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        working-directory: npm/screenrec-cli
        run: npm ci

      - name: Dry-run publish
        working-directory: npm/screenrec-cli
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public --dry-run

      - name: Publish to npm
        working-directory: npm/screenrec-cli
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public
